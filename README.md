# Salesforce Add to Permission Set

A SGNL action that adds a user to a permission set in Salesforce. This action uses a two-step process: first it finds the user by username, then creates a permission set assignment.

## Overview

This action performs the following steps:
1. Query Salesforce to find the user ID by username
2. Create a permission set assignment for that user

The action handles duplicate assignments gracefully - if the user already has the permission set, it treats this as a success rather than an error.

## Prerequisites

- Salesforce instance with API access
- Valid authentication with permissions to:
  - Query User records (`SELECT` on User object)
  - Create PermissionSetAssignment records (`INSERT` on PermissionSetAssignment object)

## Quick Start

```bash
npm install
npm test
npm run build
```

## Configuration

### Authentication

This action supports multiple authentication methods. Configure one of the following:

#### Option 1: Bearer Token
| Name | Type | Required | Description |
|------|------|----------|-------------|
| `BEARER_AUTH_TOKEN` | Secret | Yes | A valid Salesforce OAuth access token |

#### Option 2: Basic Authentication
| Name | Type | Required | Description |
|------|------|----------|-------------|
| `BASIC_USERNAME` | Secret | Yes | Username for basic auth |
| `BASIC_PASSWORD` | Secret | Yes | Password for basic auth |

#### Option 3: OAuth2 Client Credentials
| Name | Type | Required | Description |
|------|------|----------|-------------|
| `OAUTH2_CLIENT_CREDENTIALS_CLIENT_SECRET` | Secret | Yes | OAuth2 client secret |
| `OAUTH2_CLIENT_CREDENTIALS_CLIENT_ID` | Environment | Yes | OAuth2 client ID |
| `OAUTH2_CLIENT_CREDENTIALS_TOKEN_URL` | Environment | Yes | Token endpoint URL |
| `OAUTH2_CLIENT_CREDENTIALS_SCOPE` | Environment | No | OAuth2 scope |
| `OAUTH2_CLIENT_CREDENTIALS_AUDIENCE` | Environment | No | OAuth2 audience |
| `OAUTH2_CLIENT_CREDENTIALS_AUTH_STYLE` | Environment | No | Auth style: `in_header` or `in_body` |

#### Option 4: OAuth2 Authorization Code
| Name | Type | Required | Description |
|------|------|----------|-------------|
| `OAUTH2_AUTHORIZATION_CODE_ACCESS_TOKEN` | Secret | Yes | OAuth2 access token |

### Environment Variables

| Variable | Required | Description | Example |
|----------|----------|-------------|---------|
| `ADDRESS` | Yes | Default Salesforce API base URL | `https://mycompany.my.salesforce.com` |

### Input Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `username` | string | Yes | Salesforce username to add to permission set |
| `permissionSetId` | string | Yes | Salesforce permission set ID (e.g., `0PS000000000001`) |
| `address` | string | No | Salesforce instance URL (overrides `ADDRESS` environment variable) |

### Output Structure

```javascript
{
  status: 'success',
  username: 'user@example.com',
  userId: '005000000000001',
  permissionSetId: '0PS000000000001',
  assignmentId: 'PSA000000000001',  // null if user already had permission set
  address: 'https://mycompany.my.salesforce.com'
}
```

## Usage Examples

### Basic Usage

```javascript
const params = {
  username: 'john.doe@company.com',
  permissionSetId: '0PS000000000001'
};

const result = await script.invoke(params, context);
console.log(result);
// {
//   status: 'success',
//   username: 'john.doe@company.com',
//   userId: '005000000000123',
//   permissionSetId: '0PS000000000001',
//   assignmentId: 'PSA000000000456'
// }
```

## API Endpoints Used

This action makes the following Salesforce API calls:

1. **User Query**: `GET /services/data/v61.0/query?q=SELECT+Id+FROM+User+WHERE+Username+LIKE+'{username}'+ORDER+BY+Id+ASC`
2. **Permission Set Assignment**: `POST /services/data/v61.0/sobjects/PermissionSetAssignment`

## Development

### Local Testing

```bash
# Run the script locally with mock data
npm run dev -- --params '{"username": "test@example.com", "permissionSetId": "0PS000000000001"}'

# Run unit tests
npm test

# Watch mode for development
npm run test:watch
npm run build:watch

# Validate metadata
npm run validate

# Lint code
npm run lint
npm run lint:fix
```

### File Structure

- `src/script.mjs` - Main action implementation
- `metadata.yaml` - Action schema and configuration  
- `tests/script.test.js` - Unit tests
- `dist/index.js` - Built script (generated by `npm run build`)
- `scripts/` - Development utilities

## Error Handling

The action implements comprehensive error handling:

### Error Behavior
All errors are re-thrown to allow the SGNL framework to handle retry logic based on the configured retry policy.

### Common Errors
- **401/403 (Authentication/Authorization)**: Invalid or expired credentials
- **Missing required parameters**: username or permissionSetId not provided
- **User not found**: Specified username does not exist in Salesforce
- **Invalid permission set ID**: Permission set ID format is incorrect

### Duplicate Assignment Handling
When a user already has the permission set assigned, Salesforce returns a 400 error with `DUPLICATE_VALUE` error code. The action treats this as a success condition since the desired state (user has the permission set) is already achieved.

## Security Considerations

- **URL Encoding**: Username is properly URL-encoded in SOQL queries to prevent injection attacks
- **Secure Authentication**: Credentials are handled securely through the authentication framework
- **Input Validation**: All required parameters are validated before API calls
- **No Sensitive Logging**: Credentials and sensitive user data are not logged in plaintext

## Troubleshooting

### Common Issues

1. **"User not found" error**: Verify the username exists and is spelled correctly
2. **"401 Unauthorized"**: Check that your credentials are valid and not expired
3. **"403 Forbidden"**: Ensure your credentials have permissions to query Users and create PermissionSetAssignments
4. **"Invalid permission set ID"**: Verify the permission set ID format (should be 15 or 18 characters starting with "0PS")
5. **"No authentication configured"**: Ensure you have configured one of the supported authentication methods

### Testing Authentication

You can test your authentication manually:

```bash
# For Bearer Token
curl -H "Authorization: Bearer YOUR_TOKEN" \
     "https://your-instance.my.salesforce.com/services/data/v61.0/sobjects/"

# For Basic Authentication
curl -u "USERNAME:PASSWORD" \
     "https://your-instance.my.salesforce.com/services/data/v61.0/sobjects/"
```

## Testing

The test suite covers:
- ✅ Successful permission set assignment (two API calls)
- ✅ Duplicate assignment handling (400 with DUPLICATE_VALUE)
- ✅ User not found scenarios
- ✅ API authentication failures
- ✅ URL encoding of special characters in usernames
- ✅ Input validation
- ✅ Error handler behavior

Run tests with:
```bash
npm test
npm run test:coverage  # View coverage report
```

## Deployment

1. **Run tests**: `npm test`
2. **Check coverage**: `npm run test:coverage` (ensure 80%+ coverage)
3. **Validate metadata**: `npm run validate`  
4. **Build distribution**: `npm run build`
5. **Commit changes**: `git add . && git commit -m "Release v1.0.0"`
6. **Create tag**: `git tag -a v1.0.0 -m "Release v1.0.0"`
7. **Push to GitHub**: `git push origin main && git push origin v1.0.0`

## Usage in SGNL

Reference this action in a SGNL workflow:

```json
{
  "job_request": {
    "name": "add-user-to-permission-set",
    "type": "nodejs-22",
    "script": {
      "repository": "github.com/sgnl-actions/salesforce-add-to-permission-set@v1.0.0",
      "type": "nodejs"
    },
    "script_inputs": {
      "username": "john.doe@company.com",
      "permissionSetId": "0PS000000000001"
    }
  }
}
```