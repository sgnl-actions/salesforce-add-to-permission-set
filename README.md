# Salesforce Add to Permission Set

A SGNL action that adds a user to a permission set in Salesforce. This action uses a two-step process: first it finds the user by username, then creates a permission set assignment.

## Overview

This action performs the following steps:
1. Query Salesforce to find the user ID by username
2. Create a permission set assignment for that user

The action handles duplicate assignments gracefully - if the user already has the permission set, it treats this as a success rather than an error.

## Prerequisites

- Salesforce instance with API access
- Valid Salesforce OAuth access token with permissions to:
  - Query User records (`SELECT` on User object)
  - Create PermissionSetAssignment records (`INSERT` on PermissionSetAssignment object)

## Quick Start

```bash
npm install
npm test
npm run build
```

## Configuration

### Required Secrets

The action requires the following secret to be configured:

- **`SALESFORCE_ACCESS_TOKEN`** - A valid Salesforce OAuth access token with the required permissions

### Required Environment Variables

- **`SALESFORCE_INSTANCE_URL`** - Your Salesforce instance URL (e.g., `https://mycompany.my.salesforce.com`)

### Input Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `username` | string | Yes | Salesforce username to add to permission set |
| `permissionSetId` | string | Yes | Salesforce permission set ID (e.g., `0PS000000000001`) |
| `apiVersion` | string | No | Salesforce API version (defaults to `v61.0`) |

### Output Structure

```javascript
{
  status: 'success',
  username: 'user@example.com',
  userId: '005000000000001',
  permissionSetId: '0PS000000000001', 
  assignmentId: 'PSA000000000001'  // null if user already had permission set
}
```

## Usage Examples

### Basic Usage

```javascript
const params = {
  username: 'john.doe@company.com',
  permissionSetId: '0PS000000000001'
};

const result = await script.invoke(params, context);
console.log(result);
// {
//   status: 'success',
//   username: 'john.doe@company.com',
//   userId: '005000000000123',
//   permissionSetId: '0PS000000000001',
//   assignmentId: 'PSA000000000456'
// }
```

### With Custom API Version

```javascript
const params = {
  username: 'jane.smith@company.com',
  permissionSetId: '0PS000000000002',
  apiVersion: 'v60.0'
};
```

## API Endpoints Used

This action makes the following Salesforce API calls:

1. **User Query**: `GET /services/data/{apiVersion}/query?q=SELECT+Id+FROM+User+WHERE+Username+LIKE+'{username}'+ORDER+BY+Id+ASC`
2. **Permission Set Assignment**: `POST /services/data/{apiVersion}/sobjects/PermissionSetAssignment`

## Development

### Local Testing

```bash
# Run the script locally with mock data
npm run dev -- --params '{"username": "test@example.com", "permissionSetId": "0PS000000000001"}'

# Run unit tests
npm test

# Watch mode for development
npm run test:watch
npm run build:watch

# Validate metadata
npm run validate

# Lint code
npm run lint
npm run lint:fix
```

### File Structure

- `src/script.mjs` - Main action implementation
- `metadata.yaml` - Action schema and configuration  
- `tests/script.test.js` - Unit tests
- `dist/index.js` - Built script (generated by `npm run build`)
- `scripts/` - Development utilities

## Error Handling

The action implements comprehensive error handling:

### Retryable Errors
- **429 (Rate Limit)**: Automatically retried with 5-second delay
- **502/503/504 (Server Errors)**: Automatically retried with 5-second delay

### Fatal Errors
- **401/403 (Authentication/Authorization)**: No retry, immediate failure
- **Missing required parameters**: No retry, immediate failure
- **User not found**: No retry, immediate failure

### Duplicate Assignment Handling
When a user already has the permission set assigned, Salesforce returns a 400 error with `DUPLICATE_VALUE` error code. The action treats this as a success condition since the desired state (user has the permission set) is already achieved.

## Security Considerations

- **URL Encoding**: Username is properly URL-encoded in SOQL queries to prevent injection attacks
- **Bearer Token**: Access token is sent as Bearer authentication header
- **Input Validation**: All required parameters are validated before API calls
- **No Sensitive Logging**: Access tokens and user data are not logged in plaintext

## Troubleshooting

### Common Issues

1. **"User not found" error**: Verify the username exists and is spelled correctly
2. **"401 Unauthorized"**: Check that the access token is valid and not expired
3. **"403 Forbidden"**: Ensure the access token has permissions to query Users and create PermissionSetAssignments
4. **"Invalid permission set ID"**: Verify the permission set ID format (should be 15 or 18 characters starting with "0PS")

### Testing Access Token

You can test your access token manually:

```bash
curl -H "Authorization: Bearer YOUR_TOKEN" \
     "https://your-instance.my.salesforce.com/services/data/v61.0/sobjects/"
```

## Testing

The test suite covers:
- ✅ Successful permission set assignment (two API calls)
- ✅ Duplicate assignment handling (400 with DUPLICATE_VALUE)
- ✅ User not found scenarios
- ✅ API authentication failures
- ✅ URL encoding of special characters in usernames
- ✅ Custom API version usage
- ✅ Input validation
- ✅ Error handler retry logic

Run tests with:
```bash
npm test
npm run test:coverage  # View coverage report
```

## Deployment

1. **Run tests**: `npm test`
2. **Check coverage**: `npm run test:coverage` (ensure 80%+ coverage)
3. **Validate metadata**: `npm run validate`  
4. **Build distribution**: `npm run build`
5. **Commit changes**: `git add . && git commit -m "Release v1.0.0"`
6. **Create tag**: `git tag -a v1.0.0 -m "Release v1.0.0"`
7. **Push to GitHub**: `git push origin main && git push origin v1.0.0`

## Usage in SGNL

Reference this action in a SGNL workflow:

```json
{
  "job_request": {
    "name": "add-user-to-permission-set",
    "type": "nodejs-22",
    "script": {
      "repository": "github.com/sgnl-actions/salesforce-add-to-permission-set@v1.0.0",
      "type": "nodejs"
    },
    "script_inputs": {
      "username": "john.doe@company.com",
      "permissionSetId": "0PS000000000001"
    }
  }
}
```